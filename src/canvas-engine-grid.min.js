(function(i){var j=i.CE,e=j.AppObject,m=j.CE,k=j.Math,d=j.Validator,l=j.CanvasLayer,b=j.Color;var f=function(o){var n=this;n.selectable=false;n.multiSelect=false;n.areaSelect=null;n.gridLayer=null;m.call(n,o);f.initialize.apply(n)};f.prototype=Object.create(m.prototype);f.prototype.constructor=m;f.initialize=function(){var n=this;var o=n.getMouseReader();o.onmousedown(1,function(){if(n.selectable&&typeof n.areaSelect==="function"){var p=this;var t={x:Math.abs(n.viewX/n.scale),y:Math.abs(n.viewY/n.scale)};var r=k.vpv(k.sdv(n.scale,p.lastDown.left),t);var s={x:r.x,y:r.y};var q=n.getGridLayer().getGrid();n.areaSelect.apply(n,[s,q]);n.getGridLayer().refresh()}});o.onmousemove(function(s){if(n.multiSelect&&n.selectable&&typeof n.areaSelect==="function"){var p=this;var q=n.getGridLayer().getGrid();var r=null;if(p.left){r=n.getDrawedArea()}else{r=k.vpv(k.sdv(n.scale,p.lastMove),{x:-n.viewX/n.scale,y:-n.viewY/n.scale})}n.areaSelect.apply(n,[r,q]);n.getGridLayer().refresh()}})};f.prototype.getDrawedArea=function(){var p=this;var o=p.getMouseReader();var u={x:-p.viewX/p.scale,y:-p.viewY/p.scale};var s=k.vpv(k.sdv(p.scale,o.lastDown.left),u);var q=k.vpv(k.sdv(p.scale,o.lastMove),u);var r=Math.abs(q.x-s.x);var n=Math.abs(q.y-s.y);var t={x:s.x,y:s.y,width:r,height:n};t.x=s.x>q.x?t.x-r:t.x;t.y=s.y>q.y?t.y-n:t.y;return t};f.prototype.onAreaSelect=function(o){var n=this;n.areaSelect=o;return n};f.prototype.getGridLayer=function(o){o=o===undefined?{}:o;var n=this;if(n.gridLayer===null){n.gridLayer=n.createLayer({type:"grid",width:o.width,height:o.height},c)}return n.gridLayer};f.prototype.destroyGridLayer=function(){var n=this;if(n.gridLayer!==null){n.gridLayer.destroy();n.gridLayer=null}return n};f.prototype.createLayer=function(p,t){p=p===undefined?{}:p;var q=null;var o=this;p.zIndex=o.layers.length;var s=parseFloat(p.width);var n=parseFloat(p.height);p.width=isNaN(s)?o.getWidth():s;p.height=isNaN(n)?o.getHeight():n;if(t!==undefined){q=new t(p,o)}else{q=new l(p,o)}o.layers.push(q);if(o.gridLayer!==null){var r=o.layers[o.layers.length-1];o.layers[o.layers.length-1]=o.gridLayer;o.layers[o.gridLayer.zIndex]=r;r.set({zIndex:o.gridLayer.zIndex});o.gridLayer.set({zIndex:o.layers.length-1})}if(o.container!==null&&$(o.container).length>0){$(o.container).append(q.getElement())}return q};f.prototype.removeLayer=function(q){var n=this;var o=-1;if(!(q instanceof c)&&q instanceof l){o=n.layers.indexOf(q)}else{if(d.isInt(q)&&n.layers[q]!==undefined){o=q}}if(o!==-1){n.layers[o].destroy();n.layers.splice(o,1);for(var p=o;p<n.layers.length;p++){n.layers[p].set({zIndex:p})}}return n};var h=function(o){var n=this;n.width=32;n.height=32;n.x=0;n.y=0;n.fillStyle=(new b({alpha:0})).toRGBA();n.strokeStyle=(new b({alpha:1})).toRGBA();n.lineWidth=1;n.lineDash=[];n.state=0;n.i=0;n.j=0;e.call(n);n.set(o)};h.prototype=Object.create(e.prototype);h.prototype.constructor=h;h.prototype.getLine=function(){var n=this;return Math.floor(n.y/n.height)};h.prototype.getColumn=function(){var n=this;return Math.floor(n.x/n.width)};var a=function(o){console.log("initializing Abstract Grid...");var n=this;n.x=0;n.y=0;n.width=0;n.height=0;n.sw=0;n.sh=0;n.parent=null;n.fillStyle="transparent";n.strokeStyle="#000000";n.checkedArea=null;e.call(n);n.set(o)};a.prototype=Object.create(e.prototype);a.prototype.constructor=a;a.prototype.setCheckedArea=function(o){var n=this;n.checkedArea=o};a.prototype.isDrawable=function(){var n=this;return n.sw>0&&n.sh>0&&n.width>0&&n.height>0};a.prototype.draw=function(q,u){var x=this;if(x.isDrawable()){q.fillStyle="transparent";q.strokeStyle=(new b({alpha:0.1})).toRGBA();q.lineWidth=1;q.lineDash=[];var r=u.getVisibleArea();var o=r.x!==0?Math.floor(r.x/x.sw):0;var n=r.y!==0?Math.floor(r.y/x.sh):0;var w=Math.ceil((r.x+r.width)/x.sw);var v=Math.ceil((r.y+r.height)/x.sh);for(var t=o;t<w;t++){for(var s=n;s<v;s++){q.strokeRect((t*x.sw)+x.x,(s*x.sh)+x.y,x.sw,x.sh)}}if(x.checkedArea!==null){var p=x.checkedArea;q.strokeStyle="#151515";q.strokeRect(p.x,p.y,p.width,p.height)}}return x};var g=function(o){console.log("initializing Grid...");var n=this;n.rectSets=[];n.checkedSets=[];n.drawCallback=null;a.call(n,o);g.bindProperties.apply(n)};g.prototype=Object.create(a.prototype);g.prototype.constructor=g;g.prototype.drawCallback=function(o){var n=this;n.drawCallback=o};g.bindProperties=function(){var n=this;n._afterChange(function(){var o=false;if(n._isChanged("sw")||n._isChanged("sh")){o=true;n.rectSets=[]}if(n._isChanged("width")||n._isChanged("height")){o=true}if(o){n.update()}})};g.prototype.getAreaInterval=function(w){var v=this;var t=_.isNumber(w.x)?w.x:0;var s=_.isNumber(w.y)?w.y:0;var n=_.isNumber(w.width)?w.width:0;var u=_.isNumber(w.height)?w.height:0;var r=parseInt(Math.floor(s/v.sh));var q=parseInt(Math.floor(t/v.sw));var p=parseInt(Math.floor((s+u)/v.sh));var o=parseInt(Math.floor((t+n)/v.sw));return{si:r,sj:q,ei:p,ej:o}};g.prototype.getRectsFromArea=function(r){var p=[];var o=this;var n=o.getAreaInterval(r);for(var s=n.si;s<=n.ei;s++){if(o.rectSets[s]!==undefined){for(var q=n.sj;q<=n.ej;q++){if(o.rectSets[s][q]!==undefined){p.push(o.rectSets[s][q])}}}}return p};g.prototype.apply=function(o,p){var n=this;n.fillStyle=b.isColor(o.fillStyle)?o.fillStyle:n.fillStyle;n.strokeStyle=b.isColor(o.strokeStyle)?o.strokeStyle:n.strokeStyle;n.rectSets.forEach(function(q){q.forEach(function(r){if(p===undefined||p.apply(r)){r.set(o)}})});return n};g.prototype.update=function(){var v=this;var u=v.sw;var q=v.sh;var t=v.width;var p=v.height;var o;var n;if(t>0&&p>0){var s=Math.floor(t/u);var x=Math.floor(p/q);var r=0;for(o=v.rectSets.length;o<x;o++){if(v.rectSets[o]===undefined){v.rectSets[o]=[]}for(n=v.rectSets[o].length;n<s;n++){r++;v.rectSets[o][n]=new h({x:n*v.sw,y:o*v.sh,width:u,height:q,fillStyle:v.fillStyle,strokeStyle:v.strokeStyle,i:o,j:n})}}for(n=v.rectSets[0].length;n<s;n++){for(o=0;o<v.rectSets.length;o++){r++;v.rectSets[o][n]=new h({x:n*v.sw,y:o*v.sh,width:u,height:q,fillStyle:v.fillStyle,strokeStyle:v.strokeStyle,i:o,j:n})}}for(o=0;o<v.rectSets.length;o++){v.rectSets[o].length=s}v.rectSets.length=Math.min(x,v.rectSets.length)}else{v.rectSets=[]}return v};g.prototype.draw=function(r){var o=this;var t=o.rectSets.length;for(var q=0;q<t;q++){var s=o.rectSets[q].length;for(var p=0;p<s;p++){var n=o.rectSets[q][p];if(n.fillStyle!=="transparent"){r.fillStyle=n.fillStyle;r.fillRect(n.x,n.y,n.width,n.height)}if(n.strokeStyle!=="transparent"){r.setLineDash(n.lineDash);r.lineWidth=n.lineWidth;r.strokeStyle=n.strokeStyle;r.strokeRect(n.x,n.y,n.width,n.height)}if(o.drawCallback!==null){o.drawCallback(n,r)}}}return o};var c=function(p,o){var n=this;n.grid=null;l.call(n,p,o)};c.prototype=Object.create(l.prototype);c.prototype.constructor=c;c.prototype.drawRectSet=function(o){var n=this;var p=n.getContext();p.fillStyle=o.fillStyle;p.strokeStyle=o.strokeStyle;p.fillRect(o.x,o.y,o.width,o.height);p.strokeRect(o.x,o.y,o.width,o.height);return n};c.prototype.getGrid=function(){var o=this;if(o.grid===null){var p=o.width;var n=o.height;o.grid=new g({sw:p,sh:n,width:p,height:n})}return o.grid};c.prototype.setGrid=function(o){var n=this;n.grid=o};c.prototype.refresh=function(){var n=this;n.clear();n.getGrid().draw(n.getContext(),n);return n};j.CanvasEngineGrid=f;j.AbstractGrid=a;j.GridLayer=c;j.Grid=g;j.RectSet=h})(window);