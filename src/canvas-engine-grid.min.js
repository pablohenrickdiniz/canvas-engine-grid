(function(){if(CE.EXT==undefined){CE.EXT={}}CE.EXT.CanvasEngineGrid=(function(){var g=CE.CE,f=CE.Math,c=CE.EXT.Grid,e=CE.EXT.GridLayer,d=CE.Validator,b=CE.CanvasLayer;var a=function(i){var h=this;h.selectable=false;h.multiSelect=false;h.areaSelect=null;h.gridLayer=null;g.call(h,i);a.initialize.apply(h)};a.prototype=Object.create(g.prototype);a.prototype.constructor=g;a.initialize=function(){var h=this;var i=h.getMouseReader();i.onmousedown(1,function(){if(h.selectable&&typeof h.areaSelect==="function"){var j=this;var n={x:Math.abs(h.viewX/h.scale),y:Math.abs(h.viewY/h.scale)};var l=f.vpv(f.sdv(h.scale,j.lastDown.left),n);var m={x:l.x,y:l.y};var k=h.getGridLayer().getGrid();h.areaSelect.apply(h,[m,k]);h.getGridLayer().refresh()}});i.onmousemove(function(m){if(h.multiSelect&&h.selectable&&typeof h.areaSelect==="function"){var j=this;var k=h.getGridLayer().getGrid();var l=null;if(j.left){l=h.getDrawedArea()}else{l=f.vpv(f.sdv(h.scale,j.lastMove),{x:-h.viewX/h.scale,y:-h.viewY/h.scale})}h.areaSelect.apply(h,[l,k]);h.getGridLayer().refresh()}})};a.prototype.getDrawedArea=function(){var j=this;var i=j.getMouseReader();var o={x:-j.viewX/j.scale,y:-j.viewY/j.scale};var m=f.vpv(f.sdv(j.scale,i.lastDown.left),o);var k=f.vpv(f.sdv(j.scale,i.lastMove),o);var l=Math.abs(k.x-m.x);var h=Math.abs(k.y-m.y);var n={x:m.x,y:m.y,width:l,height:h};n.x=m.x>k.x?n.x-l:n.x;n.y=m.y>k.y?n.y-h:n.y;return n};a.prototype.onAreaSelect=function(i){var h=this;h.areaSelect=i;return h};a.prototype.getGridLayer=function(i){i=i===undefined?{}:i;var h=this;if(h.gridLayer===null){h.gridLayer=h.createLayer({type:"grid",width:i.width,height:i.height},CE.EXT.GridLayer)}return h.gridLayer};a.prototype.destroyGridLayer=function(){var h=this;if(h.gridLayer!==null){h.gridLayer.destroy();h.gridLayer=null}return h};a.prototype.createLayer=function(i,l){i=d.validateObject({},i);var j=null;var h=this;i.zIndex=h.layers.length;i.width=d.validateNumber(h.getWidth(),i.width);i.height=d.validateNumber(h.getHeight(),i.height);if(l!==undefined){j=new l(i,h)}else{j=new b(i,h)}h.layers.push(j);if(h.gridLayer!==null){var k=h.layers[h.layers.length-1];h.layers[h.layers.length-1]=h.gridLayer;h.layers[h.gridLayer.zIndex]=k;k.set({zIndex:h.gridLayer.zIndex});h.gridLayer.set({zIndex:h.layers.length-1})}if(h.container!==null&&$(h.container).length>0){$(h.container).append(j.getElement())}return j};a.prototype.removeLayer=function(l){var h=this;var j=-1;if(!(l instanceof CE.EXT.GridLayer)&&l instanceof b){j=h.layers.indexOf(l)}else{if(d.isInt(l)&&h.layers[l]!==undefined){j=l}}if(j!==-1){h.layers[j].destroy();h.layers.splice(j,1);for(var k=j;k<h.layers.length;k++){h.layers[k].set({zIndex:k})}}return h};return a})();CE.EXT.RectSet=(function(){var a=function(c){var b=this;b.width=32;b.height=32;b.x=0;b.y=0;b.fillStyle=(new CE.Color({alpha:0})).toRGBA();b.strokeStyle=(new CE.Color({alpha:1})).toRGBA();b.lineWidth=1;b.lineDash=[];b.state=0;b.i=0;b.j=0;CE.AppObject.call(b);b.set(c)};a.prototype=Object.create(CE.AppObject.prototype);a.prototype.constructor=a;a.prototype.getLine=function(){var b=this;return Math.floor(b.y/b.height)};a.prototype.getColumn=function(){var b=this;return Math.floor(b.x/b.width)};return a})();CE.EXT.AbstractGrid=(function(){var a=CE.AppObject,b=CE.Validator;var c=function(e){console.log("initializing Abstract Grid...");var d=this;d.x=0;d.y=0;d.width=0;d.height=0;d.sw=0;d.sh=0;d.parent=null;d.fillStyle="transparent";d.strokeStyle="#000000";a.call(d);d.set(e)};c.prototype=Object.create(a.prototype);c.prototype.constructor=c;c.prototype.isDrawable=function(){var d=this;return d.sw>0&&d.sh>0&&d.width>0&&d.height>0};c.prototype.draw=function(f,l){var o=this;if(o.isDrawable()){f.fillStyle="transparent";f.strokeStyle=(new CE.Color({alpha:0.2})).toRGBA();f.lineWidth=1;f.lineDash=[];var g=l.getVisibleArea();var e=g.x!==0?Math.floor(g.x/o.sw):0;var d=g.y!==0?Math.floor(g.y/o.sh):0;var n=Math.ceil((g.x+g.width)/o.sw);var m=Math.ceil((g.y+g.height)/o.sh);for(var k=e;k<n;k++){for(var h=d;h<m;h++){f.strokeRect((k*o.sw)+o.x,(h*o.sh)+o.y,o.sw,o.sh)}}}return o};return c})();CE.EXT.Grid=(function(){var a=function(c){console.log("initializing Grid...");var b=this;b.rectSets=[];b.checkedSets=[];CE.EXT.AbstractGrid.call(b,c);a.bindProperties.apply(b)};a.prototype=Object.create(CE.EXT.AbstractGrid.prototype);a.prototype.constructor=a;a.bindProperties=function(){var b=this;b._afterChange(function(){var c=false;if(b._isChanged("sw")||b._isChanged("sh")){c=true;b.rectSets=[]}if(b._isChanged("width")||b._isChanged("height")){c=true}if(c){b.update()}})};a.prototype.getAreaInterval=function(k){var j=this;var h=_.isNumber(k.x)?k.x:0;var g=_.isNumber(k.y)?k.y:0;var b=_.isNumber(k.width)?k.width:0;var i=_.isNumber(k.height)?k.height:0;var f=parseInt(Math.floor(g/j.sh));var e=parseInt(Math.floor(h/j.sw));var d=parseInt(Math.floor((g+i)/j.sh));var c=parseInt(Math.floor((h+b)/j.sw));return{si:f,sj:e,ei:d,ej:c}};a.prototype.getRectsFromArea=function(f){var d=[];var c=this;var b=c.getAreaInterval(f);for(var g=b.si;g<=b.ei;g++){if(c.rectSets[g]!==undefined){for(var e=b.sj;e<=b.ej;e++){if(c.rectSets[g][e]!==undefined){d.push(c.rectSets[g][e])}}}}return d};a.prototype.apply=function(c,d){var b=this;b.fillStyle=CE.Color.isColor(c.fillStyle)?c.fillStyle:b.fillStyle;b.strokeStyle=CE.Color.isColor(c.strokeStyle)?c.strokeStyle:b.strokeStyle;b.rectSets.forEach(function(e){e.forEach(function(f){if(d===undefined||d.apply(f)){f.set(c)}})});return b};a.prototype.update=function(){var m=this;var l=m.sw;var e=m.sh;var k=m.width;var d=m.height;var c;var b;if(k>0&&d>0){var g=Math.floor(k/l);var n=Math.floor(d/e);var f=0;for(c=m.rectSets.length;c<n;c++){if(m.rectSets[c]===undefined){m.rectSets[c]=[]}for(b=m.rectSets[c].length;b<g;b++){f++;m.rectSets[c][b]=new CE.EXT.RectSet({x:b*m.sw,y:c*m.sh,width:l,height:e,fillStyle:m.fillStyle,strokeStyle:m.strokeStyle,i:c,j:b})}}for(b=m.rectSets[0].length;b<g;b++){for(c=0;c<m.rectSets.length;c++){f++;m.rectSets[c][b]=new CE.EXT.RectSet({x:b*m.sw,y:c*m.sh,width:l,height:e,fillStyle:m.fillStyle,strokeStyle:m.strokeStyle,i:c,j:b})}}for(c=0;c<m.rectSets.length;c++){m.rectSets[c].length=g}m.rectSets.length=Math.min(n,m.rectSets.length)}else{m.rectSets=[]}return m};a.prototype.draw=function(c){var b=this;b.rectSets.forEach(function(d){d.forEach(function(e){c.fillStyle=e.fillStyle;c.strokeStyle=e.strokeStyle;c.setLineDash(e.lineDash);c.lineWidth=e.lineWidth;c.fillRect(e.x,e.y,e.width,e.height);c.strokeRect(e.x,e.y,e.width,e.height)})});return b};return a})();CE.EXT.GridLayer=(function(){var a=function(d,c){var b=this;b.grid=null;CE.CanvasLayer.call(b,d,c)};a.prototype=Object.create(CE.CanvasLayer.prototype);a.prototype.constructor=a;a.prototype.drawRectSet=function(c){var b=this;var d=b.getContext();d.fillStyle=c.fillStyle;d.strokeStyle=c.strokeStyle;d.fillRect(c.x,c.y,c.width,c.height);d.strokeRect(c.x,c.y,c.width,c.height);return b};a.prototype.getGrid=function(){var c=this;if(c.grid===null){var d=c.width;var b=c.height;c.grid=new CE.EXT.Grid({sw:d,sh:b,width:d,height:b})}return c.grid};a.prototype.setGrid=function(c){var b=this;b.grid=c};a.prototype.refresh=function(){var b=this;b.clear();b.getGrid().draw(b.getContext(),b);return b};return a})()})();